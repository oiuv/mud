# questd - ä»»åŠ¡å®ˆæŠ¤è¿›ç¨‹

## ğŸ“‹ æ¦‚è¿°

questd æ˜¯ç‚é»„ç¾¤ä¾ ä¼ MUDæ¸¸æˆçš„ä»»åŠ¡ç³»ç»Ÿæ ¸å¿ƒå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªæ¸¸æˆçš„ä»»åŠ¡åˆ†é…ã€å®ŒæˆéªŒè¯ã€å¥–åŠ±å‘æ”¾å’Œç‰¹æ®Šå¥–åŠ±ç³»ç»Ÿã€‚å®ƒæä¾›äº†å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä»ä»»åŠ¡æ¥å–åˆ°å®Œæˆå¥–åŠ±çš„å…¨æµç¨‹æ§åˆ¶ï¼Œæ˜¯æ¸¸æˆè¿›åº¦å’Œç©å®¶æˆé•¿çš„é‡è¦é©±åŠ¨ç³»ç»Ÿã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### 1. ä»»åŠ¡åˆ†é…ç®¡ç†
- **æ™ºèƒ½ä»»åŠ¡åˆ†é…**ï¼šæ ¹æ®ç©å®¶ç­‰çº§å’Œç»éªŒæ™ºèƒ½åŒ¹é…åˆé€‚çš„ä»»åŠ¡
- **ä»»åŠ¡ç±»å‹æ”¯æŒ**ï¼šæ”¯æŒé€ä¿¡ã€æ€äººã€å¯»ç‰©ç­‰å¤šç§ä»»åŠ¡ç±»å‹
- **ä»»åŠ¡éš¾åº¦è°ƒèŠ‚**ï¼šæ ¹æ®ç©å®¶å®åŠ›åŠ¨æ€è°ƒæ•´ä»»åŠ¡éš¾åº¦
- **NPCä»»åŠ¡åŒ¹é…**ï¼šä¸ºNPCåŒ¹é…åˆé€‚çš„ä»»åŠ¡ä¾›ç©å®¶æ¥å–

### 2. ä»»åŠ¡å®ŒæˆéªŒè¯
- **å®Œæˆæ¡ä»¶æ£€æŸ¥**ï¼šéªŒè¯ç©å®¶æ˜¯å¦æ»¡è¶³ä»»åŠ¡å®Œæˆæ¡ä»¶
- **ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª**ï¼šè·Ÿè¸ªä»»åŠ¡æ‰§è¡Œè¿›åº¦å’ŒçŠ¶æ€å˜åŒ–
- **æ—¶é—´é™åˆ¶ç®¡ç†**ï¼šç®¡ç†ä»»åŠ¡çš„æ—¶é—´é™åˆ¶å’Œè¶…æ—¶å¤„ç†
- **å¼‚å¸¸å¤„ç†**ï¼šå¤„ç†ä»»åŠ¡å¤±è´¥ã€æ”¾å¼ƒç­‰å¼‚å¸¸æƒ…å†µ

### 3. å¥–åŠ±ç³»ç»Ÿç®¡ç†
- **åŸºç¡€å¥–åŠ±å‘æ”¾**ï¼šå‘æ”¾ç»éªŒã€æ½œèƒ½ã€å¨æœ›ç­‰åŸºç¡€å¥–åŠ±
- **ç­‰çº§å¥–åŠ±ç³»ç»Ÿ**ï¼šæ ¹æ®è¿ç»­å®Œæˆä»»åŠ¡æ•°é‡å‘æ”¾ç‰¹æ®Šå¥–åŠ±
- **ç‰©å“å¥–åŠ±æ± **ï¼šç®¡ç†å¤šçº§åˆ«çš„ç‰©å“å¥–åŠ±æ± 
- **ç‰¹æ®Šå¥–åŠ±è§¦å‘**ï¼šè¾¾åˆ°ä¸€å®šæ¡ä»¶æ—¶è§¦å‘ç‰¹æ®Šå¥–åŠ±

### 4. è½¬ä¸–ç©å®¶ç‰¹æ®Šå¤„ç†
- **è¶…çº§NPCç”Ÿæˆ**ï¼šä¸ºè½¬ä¸–ç©å®¶ç”Ÿæˆç‰¹æ®ŠæŒ‘æˆ˜NPC
- **å¥–åŠ±åŠ æˆ**ï¼šè½¬ä¸–ç©å®¶è·å¾—é¢å¤–å¥–åŠ±åŠ æˆ
- **ä»»åŠ¡éš¾åº¦è°ƒæ•´**ï¼šæ ¹æ®è½¬ä¸–æ¬¡æ•°è°ƒæ•´ä»»åŠ¡éš¾åº¦

## ğŸ’» æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ•°æ®ç»“æ„

```lpc
// åŸºç¡€å¥–åŠ±ç‰©å“åˆ—è¡¨ï¼ˆ10ä¸ªä»»åŠ¡ï¼‰
string *ob1_list = ({
    "/clone/fam/etc/vit1",      // æ´»åŠ›ä¸¹1
    "/clone/fam/etc/int1",      // æ™ºåŠ›ä¸¹1
    "/clone/fam/etc/str1",      // åŠ›é‡ä¸¹1
    "/clone/fam/etc/con1",      // æ ¹éª¨ä¸¹1
    "/clone/fam/etc/dex1",      // èº«æ³•ä¸¹1
    "/clone/fam/etc/per1",      // å®¹è²Œä¸¹1
    "/clone/fam/pill/food1",    // é£Ÿç‰©ä¸¹1
    "/clone/fam/pill/neili1",   // å†…åŠ›ä¸¹1
    "/clone/fam/pill/jingli1",  // ç²¾åŠ›ä¸¹1
    "/clone/fam/pill/linghui1"  // çµæ…§ä¸¹1
});

// 30ä¸ªä»»åŠ¡å¥–åŠ±åˆ—è¡¨
string *ob2_list = ({
    "/clone/fam/etc/vit2",      // æ´»åŠ›ä¸¹2
    "/clone/fam/etc/int2",      // æ™ºåŠ›ä¸¹2
    // ... æ›´å¤šå¥–åŠ±ç‰©å“
});

// ç‰¹æ®Šå¥–åŠ±è§¦å‘é˜ˆå€¼
#define ONE_DAY         86400   // ä¸€å¤©çš„æ—¶é—´ï¼ˆç§’ï¼‰
#define MAX_QUEST_LEVEL 9       // æœ€å¤§ä»»åŠ¡ç­‰çº§
```

### ä¸»è¦å‡½æ•°æ¥å£

#### ä»»åŠ¡åˆ†é…å‡½æ•°
```lpc
int askQuest(object who, object me)
```
- **å‚æ•°è¯´æ˜**ï¼š
  - `who`: è¯·æ±‚ä»»åŠ¡çš„ç©å®¶å¯¹è±¡
  - `me`: æä¾›ä»»åŠ¡çš„NPCå¯¹è±¡
- **è¿”å›å€¼**ï¼šæˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0
- **åŠŸèƒ½**ï¼šä¸ºç©å®¶åˆ†é…åˆé€‚çš„ä»»åŠ¡

#### ä»»åŠ¡å®Œæˆå‡½æ•°
```lpc
int completeQuest(object who, object me)
```
- **å‚æ•°è¯´æ˜**ï¼š
  - `who`: å®Œæˆä»»åŠ¡çš„ç©å®¶å¯¹è±¡
  - `me`: éªŒè¯ä»»åŠ¡çš„NPCå¯¹è±¡
- **è¿”å›å€¼**ï¼šæˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0
- **åŠŸèƒ½**ï¼šéªŒè¯ä»»åŠ¡å®Œæˆå¹¶å‘æ”¾å¥–åŠ±

#### ç‰¹æ®Šå¥–åŠ±å‡½æ•°
```lpc
private void special_bonus(object me, object who, mixed arg)
```
- **åŠŸèƒ½**ï¼šæ ¹æ®ä»»åŠ¡å®Œæˆæ•°é‡å‘æ”¾ç‰¹æ®Šç‰©å“å¥–åŠ±

## ğŸ”„ å·¥ä½œæµç¨‹

### ä»»åŠ¡åˆ†é…æµç¨‹

1. **åŸºç¡€éªŒè¯é˜¶æ®µ**
   ```lpc
   // æ£€æŸ¥NPCæ˜¯å¦å¯ä»¥åˆ†é…ä»»åŠ¡
   if (!me->query("can_quest"))
       return 0;

   // æ£€æŸ¥ç©å®¶æ˜¯å¦å·²æœ‰ä»»åŠ¡
   if (who->query_temp("quest"))
       return 0;
   ```

2. **ç©å®¶èµ„æ ¼éªŒè¯**
   ```lpc
   // æ£€æŸ¥ç©å®¶ç­‰çº§å’ŒçŠ¶æ€
   if (who->query("combat_exp") < 10000)
       return 0;

   // æ£€æŸ¥æ˜¯å¦å¤„äºç‰¹æ®ŠçŠ¶æ€
   if (who->query_temp("netdead") || who->query_temp("biguan"))
       return 0;
   ```

3. **ä»»åŠ¡ç±»å‹åŒ¹é…**
   ```lpc
   // æ ¹æ®ç©å®¶ç»éªŒç¡®å®šä»»åŠ¡ç­‰çº§
   lvl = NPC_D->check_level(who);
   exp = who->query("combat_exp");

   // ç»éªŒ10ä¸‡ä»¥å†…ä¸ºé€ä¿¡ä»»åŠ¡
   if (exp < 100000)
       quest_type = "letter";
   else
       quest_type = "kill";
   ```

4. **è½¬ä¸–ç©å®¶ç‰¹æ®Šå¤„ç†**
   ```lpc
   // è½¬ä¸–ç©å®¶è·å¾—ç‰¹æ®ŠNPCä»»åŠ¡
   reborn = who->query("reborn/count");
   if (who->query("reborn") && who->query("combat_exp") > 800000 && random(50) <= reborn)
   {
       // ç”Ÿæˆè¶…çº§NPCä»»åŠ¡
       who->set_temp("super", reborn);
       ob = new(CLASS_D("generate") + "/killed_super.c");
   }
   ```

5. **ä»»åŠ¡åˆ†é…æ‰§è¡Œ**
   ```lpc
   // è®¾ç½®ä»»åŠ¡ä¿¡æ¯
   who->set_temp("quest", ([
       "id": me->query("id"),
       "name": me->name(),
       "type": quest_type,
       "time": time(),
       "level": level,
       "exp": exp
   ]));
   ```

### ä»»åŠ¡å®ŒæˆéªŒè¯æµç¨‹

1. **ä»»åŠ¡å­˜åœ¨æ€§æ£€æŸ¥**
   ```lpc
   // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰ä»»åŠ¡
   quest = who->query_temp("quest");
   if (!quest || quest["id"] != me->query("id"))
       return 0;
   ```

2. **ä»»åŠ¡ç±»å‹éªŒè¯**
   ```lpc
   // æ ¹æ®ä»»åŠ¡ç±»å‹è¿›è¡Œä¸åŒéªŒè¯
   switch (quest["type"]) {
   case "letter":
       return check_letter_quest(who, me);
   case "kill":
       return check_kill_quest(who, me);
   }
   ```

3. **æ—¶é—´é™åˆ¶æ£€æŸ¥**
   ```lpc
   // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
   if (time() - quest["time"] > ONE_DAY)
   {
       who->delete_temp("quest");
       return 0;
   }
   ```

4. **å¥–åŠ±è®¡ç®—ä¸å‘æ”¾**
   ```lpc
   // è®¡ç®—åŸºç¡€å¥–åŠ±
   lvl = NPC_D->check_level(who);
   reborn = who->query("reborn/count");
   exp = 10 + random(5) + lvl + reborn;
   pot = 5 + random(3) + lvl + reborn;
   mar = 1 + random(2);
   weiwang = 2 + random(3) + lvl / 2;
   score = 2 + random(3) + lvl / 2;

   // å‘æ”¾å¥–åŠ±
   who->add("combat_exp", exp);
   who->add("potential", pot);
   who->add("experience", mar);
   who->add("weiwang", weiwang);
   who->add("score", score);
   ```

5. **ç‰¹æ®Šå¥–åŠ±æ£€æŸ¥**
   ```lpc
   // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç‰¹æ®Šå¥–åŠ±æ¡ä»¶
   quest_count = who->query("quest_count");
   quest_count++;
   who->set("quest_count", quest_count);

   // æ ¹æ®å®Œæˆæ•°é‡å‘æ”¾ç‰¹æ®Šç‰©å“
   if (quest_count == 30 || quest_count == 50 || quest_count == 100 ||
       quest_count == 200 || quest_count == 300 || quest_count == 400 ||
       quest_count == 500 || quest_count == 600 || quest_count == 700 ||
       quest_count == 800)
   {
       special_bonus(me, who, quest_count);
   }
   ```

## âš™ï¸ å¥–åŠ±ç³»ç»Ÿè¯¦è§£

### åŸºç¡€å¥–åŠ±è®¡ç®—

åŸºç¡€å¥–åŠ±å…¬å¼ï¼š
```lpc
ç»éªŒå€¼ = 10 + random(5) + ç©å®¶ç­‰çº§ + è½¬ä¸–æ¬¡æ•°
æ½œèƒ½å€¼ = 5 + random(3) + ç©å®¶ç­‰çº§ + è½¬ä¸–æ¬¡æ•°
é˜…å†å€¼ = 1 + random(2)
å¨æœ›å€¼ = 2 + random(3) + ç©å®¶ç­‰çº§ / 2
ç§¯åˆ†å€¼ = 2 + random(3) + ç©å®¶ç­‰çº§ / 2
```

### ç‰¹æ®Šå¥–åŠ±ç­‰çº§

| å®Œæˆæ•°é‡ | å¥–åŠ±ç­‰çº§ | ç‰©å“å“è´¨ |
|----------|----------|----------|
| 30ä¸ª     | äºŒçº§å¥–åŠ± | ä¼˜è´¨ä¸¹è¯ |
| 50ä¸ª     | ä¸‰çº§å¥–åŠ± | é«˜çº§ä¸¹è¯ |
| 100ä¸ª    | å››çº§å¥–åŠ± | ç¨€æœ‰ä¸¹è¯ |
| 200ä¸ª    | äº”çº§å¥–åŠ± | çè´µä¸¹è¯ |
| 300ä¸ª    | å…­çº§å¥–åŠ± | æå“ä¸¹è¯ |
| 400ä¸ª    | ä¸ƒçº§å¥–åŠ± | ä¼ è¯´ä¸¹è¯ |
| 500ä¸ª    | å…«çº§å¥–åŠ± | ç¥è¯ä¸¹è¯ |
| 600ä¸ª    | ä¹çº§å¥–åŠ± | é¡¶çº§ä¸¹è¯ |
| 700ä¸ª    | åçº§å¥–åŠ± | è‡³å°Šä¸¹è¯ |
| 800ä¸ª    | é¡¶çº§å¥–åŠ± | é€†å¤©ä¸¹è¯ |

### è½¬ä¸–ç©å®¶åŠ æˆ

è½¬ä¸–ç©å®¶è·å¾—é¢å¤–åŠ æˆï¼š
- **åŸºç¡€å¥–åŠ±**ï¼šæ¯é¡¹å¥–åŠ± + è½¬ä¸–æ¬¡æ•°
- **è¶…çº§NPC**ï¼šæœ‰æ¦‚ç‡é‡åˆ°ç‰¹æ®Šè¶…çº§NPCï¼ˆç»éªŒ>80ä¸‡ä¸”è½¬ä¸–æ¬¡æ•°>0ï¼‰
- **ä»»åŠ¡éš¾åº¦**ï¼šè½¬ä¸–æ¬¡æ•°å½±å“ä»»åŠ¡éš¾åº¦å’Œå¥–åŠ±å“è´¨

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### ä»»åŠ¡ç³»ç»Ÿè®¾è®¡åŸåˆ™
1. **å…¬å¹³æ€§**ï¼šç¡®ä¿ä¸åŒç­‰çº§ç©å®¶éƒ½èƒ½è·å¾—åˆé€‚ä»»åŠ¡
2. **æ¸è¿›æ€§**ï¼šä»»åŠ¡éš¾åº¦éšç©å®¶æˆé•¿é€æ­¥æå‡
3. **å¤šæ ·æ€§**ï¼šæ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹ï¼Œé¿å…å•è°ƒ
4. **å¥–åŠ±å¹³è¡¡**ï¼šå¥–åŠ±ä¸æŠ•å…¥æ—¶é—´å’Œéš¾åº¦æˆæ­£æ¯”

### æ€§èƒ½ä¼˜åŒ–è€ƒè™‘
1. **ç¼“å­˜æœºåˆ¶**ï¼šé¢‘ç¹æŸ¥è¯¢çš„æ•°æ®åº”ç¼“å­˜
2. **æ‰¹é‡å¤„ç†**ï¼šå¥–åŠ±å‘æ”¾è€ƒè™‘æ‰¹é‡å¤„ç†
3. **è¶…æ—¶ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†è¶…æ—¶ä»»åŠ¡æ•°æ®
4. **å¹¶å‘å®‰å…¨**ï¼šç¡®ä¿å¤šç©å®¶åŒæ—¶æ“ä½œçš„æ­£ç¡®æ€§

### æ•°æ®ä¸€è‡´æ€§
1. **åŸå­æ“ä½œ**ï¼šå¥–åŠ±å‘æ”¾å¿…é¡»æ˜¯åŸå­æ“ä½œ
2. **çŠ¶æ€åŒæ­¥**ï¼šç¡®ä¿ä»»åŠ¡çŠ¶æ€åŒæ­¥æ›´æ–°
3. **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æƒ…å†µå¤„ç†æœºåˆ¶
4. **æ—¥å¿—è®°å½•**ï¼šé‡è¦æ“ä½œéœ€è¦è®°å½•æ—¥å¿—

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### NPCé…ç½®ä»»åŠ¡åŠŸèƒ½
```lpc
// åœ¨é—¨æ´¾ä»»åŠ¡NPCä¸­é…ç½®
void init()
{
    add_action("do_quest", "quest");
    add_action("do_complete", "complete");
}

int do_quest(string arg)
{
    // è¯·æ±‚ä»»åŠ¡
    return QUEST_D->askQuest(this_player(), this_object());
}

int do_complete(string arg)
{
    // å®Œæˆä»»åŠ¡
    return QUEST_D->completeQuest(this_player(), this_object());
}
```

### ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
```lpc
// æŸ¥è¯¢ç©å®¶ä»»åŠ¡çŠ¶æ€
mapping quest = player->query_temp("quest");
if (quest) {
    write("ä½ å½“å‰çš„ä»»åŠ¡ï¼š\n");
    write(sprintf("ä»»åŠ¡ç±»å‹ï¼š%s\n", quest["type"]));
    write(sprintf("ä»»åŠ¡æ—¶é—´ï¼š%s\n", ctime(quest["time"])));
    write(sprintf("å·²æ¥ä»»åŠ¡æ•°ï¼š%d\n", player->query("quest_count")));
}
```

### ç‰¹æ®Šå¥–åŠ±é…ç½®
```lpc
// é…ç½®ç‰¹æ®Šå¥–åŠ±ç‰©å“
string *ob5_list = ({
    "/clone/fam/pill/renshen1",     // äººå‚1
    "/clone/fam/pill/lingzhi1",     // çµèŠ1
    "/clone/fam/pill/xuelian1",     // é›ªè²1
    "/clone/fam/pill/food2",        // é£Ÿç‰©2
    "/clone/fam/pill/neili2",       // å†…åŠ›2
    "/clone/fam/pill/jingli2",      // ç²¾åŠ›2
    "/clone/fam/etc/vit3",          // æ´»åŠ›3
    "/clone/fam/etc/int3",          // æ™ºåŠ›3
    "/clone/fam/etc/str3",          // åŠ›é‡3
    "/clone/fam/etc/con3"           // æ ¹éª¨3
});
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ä»»åŠ¡å¤„ç†æ€§èƒ½
- ä»»åŠ¡åˆ†é…ï¼š<50ms
- ä»»åŠ¡å®Œæˆï¼š<30ms
- å¥–åŠ±è®¡ç®—ï¼š<10ms
- ç‰¹æ®Šå¥–åŠ±ï¼š<100ms

### å¹¶å‘å¤„ç†èƒ½åŠ›
- æ”¯æŒ1000+ç©å®¶åŒæ—¶ä»»åŠ¡
- æ¯ç§’å¤„ç†100+ä»»åŠ¡è¯·æ±‚
- æ— é”è®¾è®¡ç¡®ä¿å¹¶å‘å®‰å…¨

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡ç³»ç»Ÿæ¶æ„](../systems/quests/architecture.md) - ä»»åŠ¡ç³»ç»Ÿæ•´ä½“è®¾è®¡
- [NPCç³»ç»Ÿæ–‡æ¡£](../systems/npc/overview.md) - NPCä»»åŠ¡é…ç½®
- [å¥–åŠ±ç³»ç»Ÿè®¾è®¡](../systems/economy/rewards.md) - å¥–åŠ±æœºåˆ¶è¯´æ˜
- [è½¬ä¸–ç³»ç»Ÿæ–‡æ¡£](../features/reborn/overview.md) - è½¬ä¸–ç‰¹æ®Šå¤„ç†
- [å¹³è¡¡æ€§åˆ†æ](../systems/quests/balance.md) - ä»»åŠ¡å¹³è¡¡æ€§è®¾è®¡

---

*æœ€åæ›´æ–°: 2025-09-14*
*ç»´æŠ¤å›¢é˜Ÿ: ç‚é»„ç¾¤ä¾ ä¼ å¼€å‘ç»„*