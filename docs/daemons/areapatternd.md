# AREA_PATTERN_D - 区域模式守护进程

## 概述
AREA_PATTERN_D 是MUD游戏中的区域模式管理守护进程，负责扫描和管理区域地图模板文件。它为游戏世界提供地图模式的加载、管理和应用功能，支持将预定义的地图模式应用到游戏区域中。

## 核心功能

### 模式扫描
- **自动扫描**：启动时扫描 `/world/area_pattern/` 目录
- **模式识别**：通过 `isAreaPattern()` 方法识别有效的区域模式文件
- **模式存储**：将有效模式文件路径存储在内存数组中
- **空目录警告**：对空目录或不存在目录发出警告

### 模式管理
- **模式列表**：提供完整的模式文件列表
- **模式信息**：显示模式的详细配置信息
- **模式应用**：将选定模式应用到当前区域
- **坐标支持**：支持基于坐标的模式应用

## 主要接口函数

### 获取模式列表
```lpc
string *getPatterns()

// 返回：模式文件路径数组
// 例如：({"/world/area_pattern/city.c", "/world/area_pattern/forest.c"})
```

### 模式列表显示
```lpc
void listPatterns()

// 显示格式：
// 編號  名稱
// ==================================================================
//    0  城市模式 /world/area_pattern/city.c
//    1  森林模式 /world/area_pattern/forest.c
// ==================================================================
```

### 模式详情查询
```lpc
void patternInfo(int index)

// 显示指定索引的模式详细信息
// 包括：
// - 模式编号和名称
// - 所有样式键值对
// - 数据矩阵结构
```

### 模式应用
```lpc
void setPattern(object who, int index)

// 参数：
// who - 应用模式的对象
// index - 模式索引编号

// 应用流程：
// 1. 验证对象和环境的有效性
// 2. 获取玩家的区域坐标
// 3. 加载模式的地图样式数据
// 4. 将样式数据应用到指定坐标区域
// 5. 显示应用过程的详细信息
```

## 数据格式

### 模式文件要求
- **位置**：`/world/area_pattern/` 目录下
- **验证方法**：必须实现 `isAreaPattern()` 方法
- **接口方法**：必须实现以下方法：
  - `getName()` - 返回模式名称
  - `getMapStyle()` - 返回地图样式映射

### 地图样式结构
```lpc
mapping getMapStyle()

// 返回格式：
// ([
//     "地形类型1": ({
//         ({0, 1, 0}),
//         ({1, 1, 1}),
//         ({0, 1, 0})
//     }),
//     "地形类型2": ({
//         ({1, 0, 1}),
//         ({0, 1, 0}),
//         ({1, 0, 1})
//     })
// ])
```

## 使用示例

### 查看可用模式
```lpc
// 查看所有可用模式
AREA_PATTERN_D->listPatterns();

// 查看特定模式的详细信息
AREA_PATTERN_D->patternInfo(2);
```

### 应用模式
```lpc
// 将索引为1的模式应用到当前区域
AREA_PATTERN_D->setPattern(this_player(), 1);

// 系统会显示：
// ( 0, 0) 地形类型1 -> 1
// ( 1, 0) 地形类型1 -> 0
// ( 2, 0) 地形类型1 -> 1
```

## 内部工作流程

### 初始化扫描
```lpc
void create()
// 1. 设置有效用户ID
// 2. 扫描 /world/area_pattern/ 目录
// 3. 收集所有有效的区域模式文件
```

### 文件扫描过程
```lpc
void scanPattern(string dir)
// 1. 获取目录下的所有文件
// 2. 对每个文件检查是否为有效模式文件
// 3. 将有效文件路径添加到 patterns 数组
// 4. 处理空目录和不存在目录的警告
```

### 模式应用过程
```lpc
// 1. 验证对象有效性
// 2. 检查环境是否为区域对象
// 3. 获取玩家的区域坐标 (x_axis, y_axis)
// 4. 解析模式的地图样式数据
// 5. 按坐标将样式数据应用到区域
// 6. 实时显示应用过程
```

## 配置与限制

### 目录配置
- **固定目录**：`/world/area_pattern/`
- **文件类型**：LPC对象文件 (.c)
- **验证要求**：必须实现特定接口方法

### 使用限制
- **坐标要求**：玩家必须在区域对象环境中
- **权限要求**：无特殊权限要求
- **并发支持**：支持多用户同时使用

## 相关文件
- `/adm/daemons/areapatternd.c` - 守护进程实现
- `/world/area_pattern/` - 区域模式文件目录
- `/include/ansi.h` - ANSI颜色定义
- `/include/armor.h` - 装备系统定义

## 注意事项
- 模式文件必须正确实现所需接口方法
- 应用模式前确保玩家位于正确的区域对象中
- 模式应用会覆盖指定坐标区域的现有数据
- 模式文件路径存储在内存中，重启后需要重新扫描
- 支持动态添加新的模式文件，重启守护进程即可生效

AREA_PATTERN_D 为MUD游戏提供了灵活的地图模板系统，使游戏管理员能够快速创建和应用复杂的区域地形模式。该守护进程是游戏世界构建的重要工具。