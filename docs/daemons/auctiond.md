# AUCTION_D - 拍卖系统守护进程

## 概述
AUCTION_D 是MUD游戏中的拍卖系统守护进程，负责管理游戏内物品的拍卖流程。它提供了一个完整的拍卖平台，包括物品上架、竞价、成交、佣金收取等核心功能。

## 核心功能

### 拍卖管理
- **物品上架**：玩家提交拍卖物品和起拍价格
- **竞价系统**：支持多轮竞价，每次出价必须高于当前价格
- **自动成交**：3轮无人竞价后自动成交
- **佣金机制**：收取成交价格的4%作为佣金

### 状态监控
- **心跳机制**：每秒检查拍卖状态，更新拍卖进度
- **玩家状态**：自动清理离线玩家的拍卖品
- **物品验证**：实时验证拍卖物品的有效性

## 主要接口函数

### 添加拍卖品
```lpc
// 添加拍卖品
public void add_auction(object me, object ob, int money)

// 参数：
// me - 拍卖者对象
// ob - 拍卖物品对象
// money - 起拍价格

// 限制条件：
// - 拍卖者不能有其他正在拍卖的物品
// - 物品必须具有价值
// - 物品不能标记为不可出售
// - 物品不能是角色或货币
// - 拍卖者必须能支付佣金
```

### 参与竞价
```lpc
// 参与竞价
public void join_auction(object me, string name, int money)

// 参数：
// me - 竞价者对象
// name - 拍卖者ID
// money - 出价金额

// 限制条件：
// - 拍卖者必须有正在拍卖的物品
// - 拍卖者必须在线
// - 出价必须高于当前价格
// - 竞价者不能是上次出价者
```

### 取消拍卖
```lpc
// 取消拍卖
public void cancel_auction(object me)

// 参数：
// me - 拍卖者对象

// 取消条件：
// - 拍卖者必须有正在拍卖的物品
// - 取消后物品归还拍卖者
```

### 查询拍卖信息
```lpc
// 查看拍卖信息
public string check_auction_info()

// 返回格式化的拍卖列表，包含：
// - 拍卖者信息
// - 拍卖物品名称
// - 当前竞价者
// - 当前价格
// - 拍卖状态
```

## 拍卖数据结构

### 拍卖信息结构
```lpc
auction_info[id] = ([
    "goods" : ob,        // 拍卖物品对象
    "time"  : time(),    // 最后操作时间
    "value" : money,     // 当前价格
    "lot"   : money * lot_percent,  // 佣金
    "state" : 1,         // 拍卖轮次
    "now"   : player_id  // 当前竞价者
])
```

### 佣金计算
```lpc
#define lot_percent 4 / 100  // 4%佣金比例
```

## 拍卖流程

### 上架流程
1. 验证物品合法性和价值
2. 检查拍卖者资格和支付能力
3. 创建拍卖记录并广播消息
4. 开始第一轮拍卖

### 竞价流程
1. 验证竞价者资格和出价金额
2. 更新拍卖价格和竞价者信息
3. 重置拍卖轮次和时间
4. 广播新的竞价信息

### 成交流程
1. 检查是否达到成交条件（3轮无人竞价）
2. 验证买卖双方支付能力
3. 处理金钱交易和佣金扣除
4. 转移物品所有权
5. 清理拍卖记录

## 心跳处理

### 状态检查
```lpc
void heart_beat()
// 每秒执行一次，处理：
// - 检查所有拍卖物品状态
// - 清理离线玩家的拍卖品
// - 验证物品对象有效性
// - 处理超时拍卖（10秒无操作）
// - 自动推进拍卖轮次
```

### 超时处理
- **10秒超时**：拍卖超过10秒无人操作自动推进轮次
- **3轮成交**：达到第4轮无人竞价时自动成交
- **失败处理**：买家或卖家无法支付时取消拍卖

## 物品验证

### 合法性检查
```lpc
private string check_auction(object ob)
// 检查项目：
// - 物品是否有价值
// - 物品是否标记为不可出售
// - 物品是否标记为不可丢弃
// - 物品是否为角色
// - 物品是否为货币
// - 物品是否为食物/饮料
```

### 禁止物品类型
- 无价值物品
- 标记为 `no_sell` 或 `no_drop` 的物品
- 角色对象（NPC/玩家）
- 货币对象
- 食物和饮料

## 金钱处理

### 支付流程
```lpc
// 买家支付
MONEY_D->player_pay(ob, money)

// 卖家支付佣金
MONEY_D->player_pay(me, money * lot_percent)

// 卖家获得收益
MONEY_D->pay_player(me, money)
```

### 支付失败处理
- 买家支付失败：取消交易，拍卖继续
- 卖家支付佣金失败：取消交易，拍卖继续
- 双方都会收到相应的提示信息

## 消息广播

### 拍卖消息
```lpc
private void message_auction(string msg)
// 通过 bill 频道广播拍卖信息
// 包括：上架、竞价、成交、取消等事件
```

### 消息类型
- 拍卖开始通知
- 竞价更新通知
- 成交确认通知
- 拍卖取消通知
- 支付失败通知

## 系统启动

### 初始化
```lpc
void create()
// 1. 设置有效用户ID
// 2. 注册拍卖师频道身份
// 3. 初始化拍卖信息数据库
// 4. 启动心跳机制（每秒检查）
// 5. 广播系统启动消息
```

## 相关文件
- `/adm/daemons/auctiond.c` - 拍卖系统守护进程
- `/adm/daemons/moneyd.c` - 货币系统守护进程
- `/include/ansi.h` - ANSI颜色定义

## 注意事项
- 每个玩家同时只能拍卖一件物品
- 拍卖物品必须具有实际价值
- 佣金比例固定为成交价格的4%
- 拍卖轮次最多4轮，第4轮无人竞价即成交
- 离线玩家的拍卖品会被自动清理
- 物品转移失败时会自动取消拍卖

AUCTION_D 为MUD提供了一个完整的拍卖交易平台，使玩家能够安全、公平地进行物品交易。该守护进程是游戏经济系统的重要组成部分。