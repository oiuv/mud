# BACKUP_D - 数据备份守护进程

## 概述
BACKUP_D 是MUD游戏的数据备份守护进程，负责每日自动备份所有玩家数据。它按照预设时间表执行备份任务，管理备份文件的生命周期，确保数据安全并提供灾难恢复能力。

## 核心功能

### 自动备份
- **定时备份**：每日凌晨6:00自动执行备份
- **系统通知**：提前10分钟和1分钟发出备份提醒
- **完整备份**：备份整个 `/data/` 目录
- **版本管理**：保留15天内的备份数据

### 备份管理
- **目录创建**：按日期创建备份目录（格式：yyyy-mm-dd）
- **旧备份清理**：自动删除超过15天的备份（每月1日除外）
- **空间优化**：清理无效备份文件释放存储空间
- **完整性检查**：备份完成后验证数据完整性

## 备份时间表

### 时间配置
```lpc
// 时间配置数组
nosave int *tlist = ({ 0, 550, 559, 600 });
// 对应状态：
// 550 - 第一次提醒（5:50）
// 559 - 第二次提醒（5:59）
// 600 - 开始备份（6:00）

nosave int *hlist = ({ 45, 1, 1, 1 });
// 对应心跳间隔：
// SLEEPING: 45秒
// GET_READY/GET_READY_2/BACKUPING: 1秒
```

### 状态机
```lpc
#define SLEEPING    0    // 休眠状态
#define GET_READY   1    // 准备状态1
#define GET_READY_2 2    // 准备状态2
#define BACKUPING   3    // 备份状态
```

## 主要接口函数

### 手动备份触发
```lpc
// 手动触发备份
void backup_data()

// 使用条件：
// - 需要ROOT权限
// - 自动创建备份目录
// - 处理备份文件复制
```

### 状态查询
```lpc
// 检查是否正在备份
int is_backuping()
// 返回：1=正在备份，0=休眠状态

// 获取备份时间
int query_backup_time()
// 返回：600（6:00）
```

## 备份流程

### 自动触发流程
1. **5:50** - 第一次系统提醒
2. **5:59** - 第二次系统提醒
3. **6:00** - 开始执行备份
4. **备份中** - 显示处理进度
5. **完成后** - 清理旧备份文件

### 备份执行过程
```lpc
// 1. 检查ROOT权限
// 2. 计算当前日期
// 3. 创建备份目录（格式：/backup/yyyy-mm-dd）
// 4. 复制 /data/ 目录内容
// 5. 统计复制文件数量
// 6. 异步清理旧备份
```

## 备份存储结构

### 目录结构
```
/backup/
├── 2023-11-15/     # 备份目录
│   ├── player/     # 玩家数据
│   ├── log/        # 日志文件
│   └── ...         # 其他数据
├── 2023-11-16/
└── ...
```

### 命名规则
- **格式**：`yyyy-mm-dd`
- **示例**：`2023-11-15`
- **位置**：`/backup/` 根目录下

## 备份清理机制

### 清理策略
```lpc
void remove_backup(mixed lt)
// 清理规则：
// - 保留15天内的备份
// - 每月1日的备份永久保留
// - 按日期精确计算保留期限
// - 递归删除整个备份目录
```

### 日期计算算法
```lpc
private int is_recent_time(int y, int m, int d, int cy, int cm, int cd)
// 功能：判断备份是否在保留期限内
// 考虑闰年、月份天数差异
// 精确到天的保留期限计算
```

## 系统启动与调度

### 初始化
```lpc
void create()
// 1. 设置ROOT权限
// 2. 注册系统频道身份
// 3. 设置为休眠状态
// 4. 配置心跳间隔（45秒）
// 5. 广播系统启动消息
```

### 心跳调度
```lpc
void heart_beat()
// 1. 获取当前本地时间
// 2. 计算当前时间码（小时*100+分钟）
// 3. 根据时间表切换状态
// 4. 动态调整心跳频率
```

## 状态转换

### 状态切换逻辑
```lpc
private void change_state(int new_state)
// 状态转换：
// SLEEPING -> GET_READY -> GET_READY_2 -> BACKUPING -> SLEEPING
```

### 状态通知
- **GET_READY**：提前10分钟提醒
- **GET_READY_2**：提前1分钟提醒
- **BACKUPING**：开始备份通知
- **完成后**：备份完成通知

## 工具函数

### 目录管理
```lpc
private int assure_not_exist(string bkdir)
// 功能：确保备份目录不存在
// 处理：如果存在则删除整个目录
// 返回：1=成功，0=失败
```

### 系统通知
```lpc
private void sys_info(string msg)
// 功能：发送系统通知和日志
// 频道：sys频道广播
// 日志：backup日志文件
```

## 后续处理

### 日志管理
```lpc
// 备份完成后：
// 1. 重启所有玩家的日志记录
// 2. 检查并清理长时间不上线的玩家
// 3. 更新系统状态为休眠
```

### 检查流程
```lpc
private void check_all_player()
// 调用EXAMINE_CMD检查所有玩家
// 清理长时间不上线的用户
// 确保数据完整性
```

## 配置参数

### 系统常量
```lpc
#define BACKUP_DATE 15    // 保留15天内的备份
#define BACKUP_DIR  "/backup/"  // 备份根目录
#define DATA_DIR    "/data/"    // 数据目录
```

### 时间配置
- **备份时间**：每日6:00
- **提醒时间**：5:50和5:59
- **保留期限**：15天
- **例外规则**：每月1日备份永久保留

## 相关文件
- `/adm/daemons/backupd.c` - 备份守护进程
- `/cmds/wiz/rm` - 目录删除命令
- `/cmds/wiz/cp` - 目录复制命令
- `/cmds/std/examine` - 玩家检查命令

## 注意事项
- 备份需要ROOT权限执行
- 备份期间游戏会有短暂停滞
- 备份目录按日期命名，不可手动修改
- 每月1日的备份不会被自动删除
- 备份前会清理离线玩家的数据
- 备份完成后会自动重启玩家日志

BACKUP_D 为MUD游戏提供了自动化的数据保护机制，确保玩家数据的安全性和可恢复性。该守护进程是系统运维的重要组成部分。'