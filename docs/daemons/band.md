# BAN_D - 站点封禁守护进程

## 概述
BAN_D 是MUD游戏的站点封禁守护进程，负责管理IP地址封禁列表，防止恶意用户访问游戏服务器。它提供IP地址的加载、匹配、添加和删除功能，支持通配符匹配模式。

## 核心功能

### IP封禁管理
- **站点封禁**：基于IP地址的访问控制
- **通配符支持**：支持IP地址通配符匹配
- **文件存储**：封禁列表存储在配置文件中
- **实时生效**：封禁变更立即生效

### 匹配机制
- **精确匹配**：完整的IP地址匹配
- **通配符匹配**：支持*通配符（如：192.168.*）
- **空值保护**：处理空IP地址的边界情况

## 主要接口函数

### IP地址检查
```lpc
// 检查IP是否被封禁
int is_banned(string site)

// 参数：
// site - 要检查的IP地址
// 返回：1=被封禁，0=未被封禁

// 示例：
if (BAN_D->is_banned("192.168.1.1"))
    write("该IP地址已被封禁！\n");
```

### 封禁列表管理
```lpc
// 添加封禁站点
void add_site(string site)

// 参数：
// site - 要封禁的IP地址（支持通配符）

// 示例：
BAN_D->add_site("192.168.1.100");
BAN_D->add_site("10.0.0.*");
```

### 封禁列表管理
```lpc
// 移除封禁站点
void remove_site(string site)

// 参数：
// site - 要解禁的IP地址

// 示例：
BAN_D->remove_site("192.168.1.100");
```

### 封禁列表显示
```lpc
// 显示封禁列表
void print()

// 输出所有被封禁的IP地址
// 如果列表为空，显示相应提示
```

## 存储结构

### 封禁文件
```lpc
#define BANNED_SITES "/adm/etc/banned_sites"
// 存储位置：/adm/etc/banned_sites
// 文件格式：每行一个IP地址
// 支持注释：以#开头的行被忽略
```

### 文件格式示例
```
# 恶意用户IP
192.168.1.100
10.0.0.*
# 测试环境
172.16.0.0
```

## 匹配算法

### 通配符处理
```lpc
// 将*替换为LPC通配符格式
site = replace_string(site, "*", "%*d");

// 匹配逻辑：
// - 精确匹配：site == line
// - 通配符匹配：sscanf(site, line) == 1
```

### 匹配过程
1. 输入IP地址通配符转换
2. 遍历封禁列表中的每个条目
3. 对每个条目进行通配符转换
4. 执行精确匹配或模式匹配
5. 找到匹配立即返回封禁状态

## 初始化与加载

### 守护进程创建
```lpc
void create()
// 1. 设置有效用户ID
// 2. 加载封禁站点列表
// 3. 构建内存中的封禁数组
```

### 站点加载
```lpc
void load_sites()
// 1. 读取封禁文件内容
// 2. 按行分割处理
// 3. 过滤注释行和空行
// 4. 构建封禁站点数组
// 5. 忽略以#开头、空行、换行符的行
```

## 使用示例

### 检查IP封禁状态
```lpc
// 在登录验证中使用
void check_ip_ban(object user)
{
    string ip = query_ip_number(user);
    if (BAN_D->is_banned(ip))
    {
        tell_object(user, "您的IP地址已被封禁，无法登录游戏。\n");
        destruct(user);
    }
}
```

### 管理封禁列表
```lpc
// 添加封禁
BAN_D->add_site("192.168.1.100");

// 查看封禁列表
BAN_D->print();

// 移除封禁
BAN_D->remove_site("192.168.1.100");
```

## 边界处理

### 空值保护
```lpc
// 避免query_ip_number(ob)返回0报错
if (!site)
{
    return 0;  // 空IP地址不视为封禁
}
```

### 文件处理
- 文件不存在时正常处理
- 空文件返回空封禁列表
- 支持动态文件更新

## 相关文件
- `/adm/daemons/band.c` - 封禁守护进程
- `/adm/etc/banned_sites` - 封禁列表文件

## 注意事项
- 封禁变更会立即写入配置文件
- 通配符匹配使用LPC的sscanf格式
- 空IP地址被视为未封禁
- 封禁列表在内存中缓存，文件修改需重启守护进程
- 支持IP段封禁（如：192.168.*）

BAN_D 为MUD游戏提供了基础的IP访问控制功能，是系统安全防护的重要组成部分。该守护进程简单高效，适用于中小规模的访问控制需求。'