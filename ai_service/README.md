# AI NPCé›†æˆæŒ‡å—

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### ğŸ” **æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ**
- **é•¿æœŸè®°å¿†**: æ”¯æŒæ— é™å¯¹è¯ç§¯ç´¯ï¼Œæ— å†å²é™åˆ¶
- **è‡ªåŠ¨ä¼˜åŒ–**: æ™ºèƒ½æ‘˜è¦è§¦å‘ï¼Œå‡å°‘APIè°ƒç”¨
- **å…³ç³»è®°å¿†**: å®Œæ•´è®°å½•ç©å®¶äº’åŠ¨å†å²å’Œå…³ç³»å˜åŒ–

### âš¡ **æ€§èƒ½ä¼˜åŒ–**
- **å‘é‡ç¼“å­˜**: æŸ¥è¯¢å‘é‡ç¼“å­˜æœºåˆ¶ï¼Œæå‡å“åº”é€Ÿåº¦
- **ç¼“å­˜ä¼˜åŒ–**: MoonPalaceç¼“å­˜é”®ç¨³å®šï¼Œå‘½ä¸­ç‡æ˜¾è‘—æå‡
- **å†…å­˜é«˜æ•ˆ**: 4KB/æŸ¥è¯¢å‘é‡ï¼Œæ¸¸æˆè¿è¡ŒæœŸé—´æŒç»­æœ‰æ•ˆ

### ğŸ® **ä½¿ç”¨é…ç½®**
- **è®°å¿†å®¹é‡**: æ¯npcå¯é…ç½®memory_capacityæ¡å¯¹è¯ï¼ˆé»˜è®¤100æ¡ï¼‰
- **æ‘˜è¦æœºåˆ¶**: è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- **å®ç°ä½ç½®**: æ ¸å¿ƒé€»è¾‘åœ¨`src/udp_server.py`å’Œ`src/history_manager.py`

## ç³»ç»Ÿæ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶åŠŸèƒ½
- **udp_server.py** - ç½‘ç»œç½‘å…³ï¼šæ¥æ”¶æ¸¸æˆå®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿”å›AIå›å¤
- **npc_manager.py** - AIå¤§è„‘ï¼šåŠ è½½é…ç½®ã€ç”Ÿæˆå›å¤ã€ç®¡ç†è®°å¿†
- **memory_store.py** - é•¿æœŸè®°å¿†ï¼šå­˜å‚¨NPCå¯¹ç©å®¶çš„å…³ç³»æ•°æ®
- **history_manager.py** - å¯¹è¯è®°å½•ï¼šæ°¸ä¹…ä¿å­˜æ‰€æœ‰èŠå¤©è®°å½•ï¼ŒæŸ¥è¯¢æ—¶è¿”å›æœ€è¿‘æŒ‡å®šæ•°é‡ä½œä¸ºä¸Šä¸‹æ–‡
- **knowledge_qwen.py** - è¯­ä¹‰æœç´¢ï¼šå‘é‡çŸ¥è¯†æ£€ç´¢ï¼ˆåƒé—®ï¼‰
- **knowledge_basic.py** - å…³é”®è¯æœç´¢ï¼šåŸºç¡€æ–‡æœ¬åŒ¹é…å›é€€æ–¹æ¡ˆ

### æ•°æ®æµå‘
æ¸¸æˆå®¢æˆ·ç«¯ â†’ udp_server.py â†’ npc_manager.py â†’ [è®°å¿†+å†å²+çŸ¥è¯†åº“] â†’ å¤§æ¨¡å‹ â†’ å›å¤

## å¿«é€Ÿåˆ›å»ºæ–°çš„AI NPC

### 1. é…ç½®NPCè§’è‰²
ç¼–è¾‘ `ai_service/config/npc_roles.json`ï¼Œæ·»åŠ æ–°NPCé…ç½®ï¼š

```json
{
  "your_npc_id": {
    "name": "NPCæ˜¾ç¤ºåç§°",
    "title": "NPCç§°å·",
    "role": "è§’è‰²ç±»å‹",
    "personality": "æ€§æ ¼æè¿°",
    "background": "èƒŒæ™¯æ•…äº‹",
    "greeting": "åˆæ¬¡è§é¢é—®å€™è¯­",
    "topics": ["è¯é¢˜1", "è¯é¢˜2", "è¯é¢˜3"],
    "speech_style": "è¯´è¯é£æ ¼",
    "knowledge_base": ["çŸ¥è¯†é¢†åŸŸ1", "çŸ¥è¯†é¢†åŸŸ2"],
    "knowledge_threshold": 0.4,  // çŸ¥è¯†åº“åŒ¹é…é˜ˆå€¼ï¼Œ0-1ä¹‹é—´ï¼Œ0=åŒ¹é…æ‰€æœ‰ï¼Œ1=ç¦ç”¨åŒ¹é…ï¼Œ0.5-0.7ä¸ºæ¨èèŒƒå›´
    "memory_capacity": 100,  // è®°å¿†å®¹é‡ï¼š0=ç¦ç”¨å†å²è®°å¿†ï¼Œ1-9=è‡ªåŠ¨è°ƒæ•´ä¸º10ï¼Œâ‰¥10=ä½¿ç”¨æŒ‡å®šå€¼ï¼Œæ¨è100-200
    "relationship_tips": {
      "gifts": ["é—¨æ´¾ç§˜ç±", "ç¨€æœ‰è£…å¤‡", "é“¶ä¸¤"],  // èµ é€ç¤¼ç‰©æå‡å…³ç³»
      "topics": ["å„é—¨æ´¾ç‰¹è‰²", "æ­¦åŠŸæ­é…æŠ€å·§"],  // å–œæ¬¢çš„è¯é¢˜
      "taboos": ["è¯¢é—®å¤–æŒ‚", "ç´¢è¦ç®¡ç†å‘˜æƒé™"]  // ç¦å¿Œè¯é¢˜
    }
  }
}
```

### 2. åˆ›å»ºNPCæ–‡ä»¶
å¤åˆ¶æ¨¡æ¿æ–‡ä»¶å¹¶ä¿®æ”¹é…ç½®ï¼š

```bash
cp u/mudren/npc/ai_npc_template.c clone/npc/ä½ çš„npcå.c
```

### 3. ä¿®æ”¹NPCé…ç½®
åœ¨ä½ çš„NPCæ–‡ä»¶ä¸­ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š

```lpc
// ä¿®æ”¹è¿™äº›é…ç½®é¡¹
set_name("å¼ ä¸‰", ({"zhang san", "zhangsan", "zhang"}));
set("title", "æ±Ÿæ¹–æ¸¸ä¾ ");
set("long", "è¿™é‡Œå†™NPCæè¿°...");
set("ai_npc_id", "zhang_san");  // å¿…é¡»ä¸jsonä¸­çš„é”®åŒ¹é…
set("ai_topics", ({"æ­¦åŠŸ", "æ±Ÿæ¹–", "ç¾é£Ÿ"}));
```

### 4. æ”¾ç½®NPC
å°†NPCæ”¾ç½®åˆ°æ¸¸æˆä¸–ç•Œä¸­ï¼Œåœ¨æˆ¿é—´æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```lpc
// æ–¹æ³•ä¸€ï¼šåœ¨æˆ¿é—´createå‡½æ•°ä¸­è®¾ç½®
void create() {
    ::create();
    set("short", "æˆ¿é—´åç§°");
    set("long", "æˆ¿é—´æè¿°...");
    set("objects", ([
        "/clone/npc/ä½ çš„npcå" : 1,     // å•ä¸ªNPC
        "/clone/npc/å¦ä¸€ä¸ªnpc" : 2,     // å¤šä¸ªç›¸åŒNPC
    ]));
    setup();
}

// æ–¹æ³•äºŒï¼šç®¡ç†å‘˜åŠ¨æ€æ·»åŠ 
// ç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨ï¼šclone /clone/npc/ä½ çš„npcå
```

## æ”¹é€ ç°æœ‰NPCä¸ºAI

### 1. æ·»åŠ AIé…ç½®
åœ¨ç°æœ‰NPCçš„create()å‡½æ•°ä¸­æ·»åŠ ï¼š
```lpc
set("ai_npc_id", "zhou butong");  // å¯¹åº”jsonä¸­çš„é”®å
```

### 2. æ·»åŠ AIå¯¹è¯å…¥å£
åœ¨ç°æœ‰NPCä¸­æ·»åŠ ï¼š
```lpc
int accept_talk(object me, string topic) {
    string player_id = me->query("id");
    string player_name = me->name();

    mapping context = ([
        "time": NATURE_D->game_time(),
        "location": environment(this_object())->query("short"),
        "weather": NATURE_D->outdoor_room_description()
    ]);

    if (!topic || topic == "") {
        topic = "ä½ å¥½";
    }

    AI_CLIENT_D->send_chat_request(
        query("ai_npc_id"),
        player_id,
        player_name,
        topic,
        context
    );

    return 1;
}
```

## é…ç½®ç¤ºä¾‹

ç¼–è¾‘æ–‡ä»¶ï¼š`ai_service/config/npc_roles.json`

### 1. æ±Ÿæ¹–ä¾ å®¢
```json
{
  "li bai": {
    "name": "æç™½",
    "title": "è¯—å‰‘åŒç»",
    "personality": "è±ªçˆ½ä»—ä¹‰ï¼Œå«‰æ¶å¦‚ä»‡",
    "background": "è¡Œèµ°æ±Ÿæ¹–äºŒåè½½ï¼Œå‰‘ä¸‹æ–©å°½ä¸å¹³äº‹",
    "topics": ["æ­¦åŠŸ", "æ±Ÿæ¹–", "æ­£ä¹‰", "å‰‘å®¢"],
    "memory_capacity": 150  // è®°å¿†å®¹é‡ï¼š0=ç¦ç”¨å†å²è®°å¿†ï¼Œ1-9=è‡ªåŠ¨è°ƒæ•´ä¸º10ï¼Œâ‰¥10=ä½¿ç”¨æŒ‡å®šå€¼
  }
}
```

### 2. å•†äººNPC
```json
{
  "wang zhanggui": {
    "name": "ç‹æŒæŸœ",
    "title": "å•†ä¼šä¼šé•¿",
    "personality": "ç²¾æ˜èƒ½å¹²ï¼Œå–„äºç»å•†",
    "background": "ç»è¥ç™¾å¹´è€åº—ï¼Œè§å¤šè¯†å¹¿",
    "topics": ["ç”Ÿæ„", "å•†å“", "è¡Œæƒ…", "å„åœ°ç‰¹äº§"],
    "memory_capacity": 80  // å•†äººNPCè®°å¿†è¾ƒçŸ­ï¼Œä¸»è¦å…³æ³¨å½“å‰äº¤æ˜“
  }
}
```

## ç›¸å…³æ–‡æ¡£
- **AI_CLIENT_D**ï¼š`/adm/daemons/ai_client_d.c` - æ¸¸æˆå†…AIå®¢æˆ·ç«¯å®ˆæŠ¤ç¨‹åºï¼Œå¤„ç†NPCä¸PythonæœåŠ¡ç«¯çš„é€šä¿¡
- **talkæŒ‡ä»¤**ï¼š`/cmds/std/talk.c` - ç©å®¶talkå‘½ä»¤å®ç°ï¼Œç”¨äºä¸AI NPCå¯¹è¯

## æµ‹è¯•å‘½ä»¤

æ¸¸æˆå†…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•ï¼š
```
talk npc_id æµ‹è¯•æ¶ˆæ¯
```

## æ³¨æ„äº‹é¡¹
1. **ai_npc_id** å¿…é¡»ä¸jsoné…ç½®ä¸­çš„é”®å®Œå…¨ä¸€è‡´
2. é‡å¯AIæœåŠ¡åé…ç½®ç”Ÿæ•ˆ


## æœåŠ¡ç«¯ä½¿ç”¨

### 1. é…ç½®ç¯å¢ƒå˜é‡
```bash
cd ai_service
echo "OPENAI_API_KEY=ä½ çš„æœˆä¹‹æš—é¢APIå¯†é’¥" > .env
echo "OPENAI_BASE_URL=https://api.moonshot.cn/v1" >> .env
echo "OPENAI_MODEL=moonshot-v1-auto" >> .env
echo "DASHSCOPE_API_KEY=ä½ çš„åƒé—®APIå¯†é’¥" >> .env
```

### 2. åˆå§‹åŒ–çŸ¥è¯†åº“
```bash
# åŸºç¡€å…³é”®è¯æœç´¢
python scripts/setup_basic.py

# åƒé—®å‘é‡æœç´¢ï¼ˆæ¨èï¼‰
python scripts/setup_qwen.py
```

### 3. å¯åŠ¨æœåŠ¡ç«¯
```bash
python main.py          # æ­£å¸¸æ¨¡å¼
python main.py -d       # è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰
```
